'use strict';function scheduleIdle(task,timeout=1500){if(typeof window!=='undefined'&&'requestIdleCallback'in window){window.requestIdleCallback(task,{timeout});return;}
window.setTimeout(task,0);}
function safeGetStorage(key){try{return localStorage.getItem(key);}catch(error){console.warn('Unable to read localStorage:',error);return null;}}
function safeSetStorage(key,value){try{localStorage.setItem(key,value);}catch(error){console.warn('Unable to write localStorage:',error);}}
const CNEMonitor=(()=>{console.log('CNEMonitor module initialized');const targetDate1=new Date('2024-07-30T22:00:00Z');const targetDate2=new Date('2024-08-29T02:00:00Z');const counterIntervals=new Map();function setThemeIcon(isDarkMode){const sunIcon=document.querySelector('#toggleTheme .icon-sun');const moonIcon=document.querySelector('#toggleTheme .icon-moon');if(!sunIcon||!moonIcon){return;}
const showSun=Boolean(isDarkMode);sunIcon.setAttribute('aria-hidden',String(!showSun));moonIcon.setAttribute('aria-hidden',String(showSun));}
function buildOdometer(numberSpan,valueText){numberSpan.textContent='';numberSpan.classList.add('odometer');numberSpan.dataset.value=valueText;numberSpan.dataset.digits=String(valueText.length);numberSpan.dataset.ready='false';valueText.split('').forEach((digitChar)=>{const digit=document.createElement('span');digit.className='odometer-digit';const roller=document.createElement('span');roller.className='odometer-roller';for(let i=0;i<10;i+=1){const num=document.createElement('span');num.className='odometer-number';num.textContent=String(i);roller.appendChild(num);}
roller.style.transform=`translateY(-${Number(digitChar) || 0}em)`;digit.appendChild(roller);numberSpan.appendChild(digit);});window.requestAnimationFrame(()=>{numberSpan.dataset.ready='true';});}
function updateOdometer(numberSpan,valueText){const needsRebuild=!numberSpan.classList.contains('odometer')||numberSpan.dataset.digits!==String(valueText.length);if(needsRebuild){buildOdometer(numberSpan,valueText);return;}
const digits=numberSpan.querySelectorAll('.odometer-digit');valueText.split('').forEach((digitChar,index)=>{const digit=digits[index];if(!digit){return;}
const roller=digit.querySelector('.odometer-roller');if(!roller){return;}
const digitValue=Number(digitChar)||0;roller.style.transform=`translateY(-${digitValue}em)`;});numberSpan.dataset.value=valueText;}
function updateCounter(elementId,targetDate){console.log(`Updating counter: ${elementId}`);const counter=document.getElementById(elementId);if(!counter){console.error(`Counter element with id ${elementId} not found`);return;}
const targetTime=targetDate.getTime();if(Number.isNaN(targetTime)){console.error(`Invalid target date for counter: ${elementId}`);return;}
if(counterIntervals.has(elementId)){window.clearInterval(counterIntervals.get(elementId));counterIntervals.delete(elementId);}
counter.textContent='';const spans=['days','hours','minutes','seconds'].map((unit)=>{const span=document.createElement('span');span.className=unit;const numberSpan=document.createElement('span');numberSpan.className='number';const labelNode=document.createTextNode('');span.append(numberSpan,labelNode);counter.appendChild(span);return{span,numberSpan,labelNode};});function update(){try{const differenceInMs=Math.max(0,Date.now()-targetTime);const days=Math.floor(differenceInMs/(1000*60*60*24));const hours=Math.floor((differenceInMs%(1000*60*60*24))/(1000*60*60),);const minutes=Math.floor((differenceInMs%(1000*60*60))/(1000*60),);const seconds=Math.floor((differenceInMs%(1000*60))/1000);const units=[{value:days,singular:'día',plural:'días'},{value:hours,singular:'hora',plural:'horas'},{value:minutes,singular:'minuto',plural:'minutos'},{value:seconds,singular:'segundo',plural:'segundos'},];units.forEach(({value,singular,plural},index)=>{const{numberSpan,labelNode}=spans[index];const valueText=index>=1?String(value).padStart(2,'0'):String(value);const labelText=` ${value === 1 ? singular : plural}`;updateOdometer(numberSpan,valueText);if(labelNode.textContent!==labelText){labelNode.textContent=labelText;}});if(elementId==='counter2'){updateHeroSuptitle(days);}}catch(error){console.error('Error updating counter:',error);}}
update();const intervalId=window.setInterval(update,1000);counterIntervals.set(elementId,intervalId);console.log(`Counter ${elementId} update started`);}
function toggleTheme(){console.log('Toggling theme');try{document.body.classList.toggle('dark-mode');const isDarkMode=document.body.classList.contains('dark-mode');safeSetStorage('theme',isDarkMode?'dark':'light');const toggleThemeBtn=document.getElementById('toggleTheme');if(toggleThemeBtn){toggleThemeBtn.setAttribute('aria-pressed',String(isDarkMode));}
setThemeIcon(isDarkMode);console.log(`Theme set to: ${isDarkMode ? 'dark' : 'light'}`);}catch(error){console.error('Error toggling theme:',error);}}
function initCounters(){updateCounter('counter1',targetDate1);updateCounter('counter2',targetDate2);}
function initThemeToggle(){const toggleThemeBtn=document.getElementById('toggleTheme');if(toggleThemeBtn){toggleThemeBtn.addEventListener('click',toggleTheme);toggleThemeBtn.setAttribute('aria-pressed','false');setThemeIcon(document.body.classList.contains('dark-mode'));console.log('Theme toggle button listener added');return toggleThemeBtn;}
console.warn('Theme toggle button not found');return null;}
function applySavedTheme(toggleThemeBtn){const savedTheme=safeGetStorage('theme');if(savedTheme!=='dark'){return;}
document.body.classList.add('dark-mode');if(toggleThemeBtn){toggleThemeBtn.setAttribute('aria-pressed','true');}
setThemeIcon(true);console.log('Dark mode applied from saved preference');}
function initAOS(){if(typeof AOS!=='undefined'){AOS.init({duration:1000,once:true,});console.log('AOS initialized');return;}
console.warn('AOS library not found');}
const ANALYTICS_ID='G-6VHH01PXKS';function bootstrapAnalytics(){window.dataLayer=window.dataLayer||[];function gtag(){window.dataLayer.push(arguments);}
window.gtag=gtag;gtag('js',new Date());gtag('config',ANALYTICS_ID);}
function sendPageView(){if(typeof gtag!=='function'){console.warn('Google Analytics gtag function not found. Make sure the Google Analytics script is loaded correctly.',);return;}
console.log('Sending Google Analytics pageview event');gtag('event','page_view',{page_title:document.title,page_location:window.location.href,page_path:window.location.pathname,});console.log('Google Analytics pageview event sent successfully');}
function loadAnalytics(){if(window.gtag){sendPageView();return;}
const existingScript=document.querySelector('script[src^="https://www.googletagmanager.com/gtag/js"]',);if(existingScript){return;}
const script=document.createElement('script');script.async=true;script.src=`https://www.googletagmanager.com/gtag/js?id=${ANALYTICS_ID}`;script.onload=()=>{bootstrapAnalytics();sendPageView();};script.onerror=()=>{console.warn('Unable to load Google Analytics script.');};document.head.appendChild(script);}
function initAnalytics(){const loadAnalyticsWhenIdle=()=>scheduleIdle(loadAnalytics);if(document.readyState==='complete'){loadAnalyticsWhenIdle();return;}
window.addEventListener('load',loadAnalyticsWhenIdle,{once:true});}
function runInitialization(){const toggleThemeBtn=initThemeToggle();applySavedTheme(toggleThemeBtn);scheduleIdle(initCounters);scheduleIdle(initAOS);initAnalytics();}
function initializePage(){console.log('Initializing page');try{runInitialization();console.log('Page initialization complete');}catch(error){console.error('Error during page initialization:',error);}}
return{init:initializePage,toggleTheme:toggleTheme,};})();document.addEventListener('DOMContentLoaded',()=>{console.log('DOM fully loaded');CNEMonitor.init();});window.addEventListener('error',(event)=>{console.error('Unhandled error:',event.error);});const DEFAULT_LANG='es';const SUPPORTED_LANGS=['es','en'];const TRANSLATIONS_URL='assets/data/translations.json';const DEFAULT_TRANSLATIONS={hero_suptitle:'Última verificación: {{date}} · {{days}} días sin resultados desagregados publicados (CNE, archivo)',cred_docs:'Documentos oficiales/legales enlazados: {{count}}',cred_update:'Última actualización de datos: {{date}}',};let translationsCache=null;async function loadTranslations(){if(translationsCache){return translationsCache;}
const response=await fetch(TRANSLATIONS_URL,{cache:'force-cache'});if(!response.ok){throw new Error(`Unable to load translations (${response.status})`);}
translationsCache=await response.json();return translationsCache;}
function getTranslationTemplate(lang,key){if(translationsCache&&translationsCache[lang]&&translationsCache[lang][key]){return translationsCache[lang][key];}
if(lang===DEFAULT_LANG&&Object.prototype.hasOwnProperty.call(DEFAULT_TRANSLATIONS,key)){return DEFAULT_TRANSLATIONS[key];}
return DEFAULT_TRANSLATIONS[key]||'';}
const PAGE_TITLES={es:'Incumplimientos verificables del CNE — Elecciones 2024',en:'Verifiable CNE breaches — 2024 Election',};const HIGHLIGHT_OBSERVER_OPTIONS={threshold:1.0};let highlightObserver=null;function getSafeLang(lang){return SUPPORTED_LANGS.includes(lang)?lang:DEFAULT_LANG;}
function getPageTitle(lang){return PAGE_TITLES[lang]||PAGE_TITLES[DEFAULT_LANG];}
function getHighlightObserver(){if(!('IntersectionObserver'in window)){return null;}
if(!highlightObserver){highlightObserver=new IntersectionObserver((entries,observer)=>{entries.forEach((entry)=>{if(entry.isIntersecting){entry.target.classList.add('active');observer.unobserve(entry.target);}});},HIGHLIGHT_OBSERVER_OPTIONS);}
return highlightObserver;}
function observeHighlights(root=document){const highlights=root.querySelectorAll('.highlight-text');if(!highlights.length){return;}
const observer=getHighlightObserver();highlights.forEach((element)=>{if(!observer){element.classList.add('active');return;}
observer.observe(element);});}
const STATUS_LABEL_STYLES={cumplido:'status-tag-met','no cumplido':'status-tag-failed',incumplido:'status-tag-failed',met:'status-tag-met',failed:'status-tag-failed',};function decorateStatusSteps(root=document){const statusItems=root.querySelectorAll('.story-list-status li');if(!statusItems.length){return;}
statusItems.forEach((item)=>{const rawText=item.textContent.trim();const match=rawText.match(/^([^:]+):\s*(.+)$/);if(!match){return;}
const label=match[1].trim();const detail=match[2].trim();const normalizedLabel=label.toLowerCase();const variantClass=STATUS_LABEL_STYLES[normalizedLabel]||'';const labelSpan=document.createElement('span');labelSpan.className=variantClass?`status-tag ${variantClass}`:'status-tag';labelSpan.textContent=label;const detailSpan=document.createElement('span');detailSpan.className='status-detail';detailSpan.textContent=detail;item.textContent='';item.append(labelSpan,detailSpan);});}
const storedLang=safeGetStorage('site_lang');let currentLang=getSafeLang(storedLang);const HERO_SUPTITLE_PLACEHOLDER='{{days}}';const HERO_SUPTITLE_DATE_PLACEHOLDER='{{date}}';const HERO_LAST_VERIFIED='2026-01-15';const CREDIBILITY_DOCS_PLACEHOLDER='{{count}}';const CREDIBILITY_DATE_PLACEHOLDER='{{date}}';const CREDIBILITY_DOCS_COUNT=7;const CREDIBILITY_LAST_DATA_UPDATE='2025-05-27';let latestCounter2Days=null;function formatHeroSuptitle(lang,days){const safeLang=getSafeLang(lang);const template=getTranslationTemplate(safeLang,'hero_suptitle');const resolvedDays=Number.isFinite(days)?Math.max(0,Math.floor(days)):null;const daysText=resolvedDays===null?'0':String(resolvedDays);const dateText=HERO_LAST_VERIFIED||'';return template.replace(HERO_SUPTITLE_DATE_PLACEHOLDER,dateText).replace(HERO_SUPTITLE_PLACEHOLDER,daysText);}
function formatCredDocs(lang){const safeLang=getSafeLang(lang);const template=getTranslationTemplate(safeLang,'cred_docs');return template.replace(CREDIBILITY_DOCS_PLACEHOLDER,String(CREDIBILITY_DOCS_COUNT));}
function formatCredUpdate(lang){const safeLang=getSafeLang(lang);const template=getTranslationTemplate(safeLang,'cred_update');const dateText=CREDIBILITY_LAST_DATA_UPDATE||'';return template.replace(CREDIBILITY_DATE_PLACEHOLDER,dateText);}
function updateHeroSuptitle(days){if(Number.isFinite(days)){latestCounter2Days=Math.max(0,Math.floor(days));}
const heroSuptitle=document.querySelector('[data-i18n="hero_suptitle"]');if(!heroSuptitle){return;}
heroSuptitle.textContent=formatHeroSuptitle(currentLang,latestCounter2Days);}
function setMissionText(element,entry){if(!element){return;}
if(!entry||typeof entry!=='object'){element.textContent=entry||'';return;}
element.textContent='';element.append(document.createTextNode(entry.prefix||''));const strong=document.createElement('strong');strong.className='highlight-text';strong.textContent=entry.highlight||'';element.append(strong);element.append(document.createTextNode(entry.suffix||''));}
async function updateLanguage(lang){const resolvedLang=getSafeLang(lang);let langTranslations=null;try{const loadedTranslations=translationsCache||(await loadTranslations());langTranslations=loadedTranslations[resolvedLang]||loadedTranslations[DEFAULT_LANG]||loadedTranslations[SUPPORTED_LANGS[0]]||{};}catch(error){console.warn('Unable to load translations:',error);langTranslations=translationsCache?.[DEFAULT_LANG]||{};}
document.documentElement.lang=resolvedLang;document.querySelectorAll('[data-i18n]').forEach((el)=>{const key=el.getAttribute('data-i18n');if(!Object.prototype.hasOwnProperty.call(langTranslations,key)){return;}
if(key==='hero_suptitle'){el.textContent=formatHeroSuptitle(resolvedLang,latestCounter2Days);}else if(key==='cred_docs'){el.textContent=formatCredDocs(resolvedLang);}else if(key==='cred_update'){el.textContent=formatCredUpdate(resolvedLang);}else if(key==='mission_text'){setMissionText(el,langTranslations[key]);}else if(key.startsWith('org_')){el.textContent=langTranslations[key];}else{el.textContent=langTranslations[key];}});observeHighlights();decorateStatusSteps();const toggleBtn=document.getElementById('toggleLang');if(toggleBtn){toggleBtn.textContent=resolvedLang==='es'?'ES':'EN';}
document.title=getPageTitle(resolvedLang);safeSetStorage('site_lang',resolvedLang);currentLang=resolvedLang;}
function initShareButtons(){const shareButtons=document.querySelectorAll('[data-share-platform]');if(!shareButtons.length){return;}
const bypassNativeSharePlatforms=new Set(['instagram','tiktok']);shareButtons.forEach((button)=>{button.addEventListener('click',async(event)=>{const shareUrl=window.location.href;const platform=button.dataset.sharePlatform||'';const usesNativeShare=!bypassNativeSharePlatforms.has(platform);const shareData={title:document.title,text:document.title,url:shareUrl,};if(!usesNativeShare){event.preventDefault();if(navigator.clipboard){try{await navigator.clipboard.writeText(shareUrl);}catch(error){console.warn('Unable to copy share URL:',error);}}
const fallbackUrl=button.getAttribute('href');if(fallbackUrl){window.open(fallbackUrl,'_blank','noopener');}
return;}
if(!navigator.share&&!navigator.clipboard){return;}
event.preventDefault();if(navigator.share){try{await navigator.share(shareData);return;}catch(error){if(error&&error.name==='AbortError'){return;}}}
if(navigator.clipboard){try{await navigator.clipboard.writeText(shareUrl);}catch(error){console.warn('Unable to copy share URL:',error);}}
const fallbackUrl=button.getAttribute('href');if(fallbackUrl){window.open(fallbackUrl,'_blank','noopener');}});});}
document.addEventListener('visibilitychange',function(){if(document.hidden){document.title="⚠️ Tiempo Agotado - CNE Venezuela";}else{document.title=getPageTitle(currentLang);}});document.addEventListener('DOMContentLoaded',()=>{if(currentLang!==DEFAULT_LANG){scheduleIdle(()=>{void updateLanguage(currentLang);});}else{scheduleIdle(()=>{observeHighlights();decorateStatusSteps();});}
scheduleIdle(initShareButtons);const langBtn=document.getElementById('toggleLang');if(langBtn){langBtn.addEventListener('click',()=>{const newLang=currentLang==='es'?'en':'es';void updateLanguage(newLang);});}});